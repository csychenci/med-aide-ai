# 基于 Next.js + Node.js 的临床语音转写系统详细设计文档（增强版）

---

## **一、新增需求说明**
1. **存储原始对话内容与录音源文件**  
   - 需永久保留用户语音录音文件（如.wav/.mp3）及对应的转写文本，支持历史记录回溯。  
2. **报告生成准确性及固定排版**  
   - 报告模板需预定义样式（如标题、段落、表格），避免用户编辑后导出时格式错乱。  
3. **提示词工程优化**  
   - 设计临床场景专用的提示词模板，提升AI生成建议的准确性和专业性。  

---

## **二、功能模块划分与技术实现**

---

### **1. 用户认证模块**  
#### 需求  
- 支持多角色登录（医生、护士、管理员）。  
- 用户操作日志关联录音和报告记录。  

#### 技术栈  
- **前端**  
  - `NextAuth.js` + `JWT`：实现第三方登录与会话管理。  
  - `Redux Toolkit`：全局状态管理（用户权限、操作日志）。  
- **后端**  
  - `Express.js` + `MongoDB`：存储用户信息、操作日志。  
  - `阿里云OSS`：独立存储录音文件（与数据库记录关联）。  

---

### **2. 语音输入与存储模块**  
#### 需求  
- 录音文件需加密存储，并关联转写文本和操作记录。  
- 支持录音片段标记（如重要时间点注释）。  

#### 技术栈  
- **前端**  
  - `WebRTC`：浏览器端录音（格式：WebM → 转码为MP3）。  
  - `react-audio-recorder`：录音组件集成。  
- **后端**  
  - `阿里云OSS`：存储原始录音文件（路径存入MongoDB）。  
  - `FFmpeg`（微服务）：音频转码与分段处理。  
- **安全**  
  - 录音文件加密：AES-256加密后上传。  

---

### **3. AI处理与提示词工程模块**  
#### 需求  
- 根据临床场景优化提示词，例如：  
  ```text  
  "你是一名医生，请根据以下患者症状和检查结果，生成诊断建议：{文本}"  
  ```  
- 支持动态插入上下文（如患者病史、药物过敏）。

#### 技术栈  
- **前端**  
  - 提示词模板管理界面：React + Ant Design Table。  
- **后端**  
  - `Python微服务`：运行提示词优化引擎（LangChain框架）。  
  - 集成模型：  
    - **实体识别**：spaCy + 自定义临床术语库。  
    - **建议生成**：GPT-4 + 提示词模板（JSON配置化）。  
- **数据流**  
  ```text  
  原始文本 → 术语替换 → 动态提示词填充 → AI生成 → 返回结构化结果  
  ```  

---

### **4. 报告生成与排版模块**  
#### 需求  
- 提供3种预定义模板（基础报告、详细报告、科研格式）。  
- 用户编辑时实时预览PDF效果，避免格式错位。  

#### 技术栈  
- **前端**  
  - `React-PDF`：PDF实时预览组件。  
  - 模板选择器：Tailwind CSS + 缩略图对比。  
- **后端**  
  - `Puppeteer`：服务端HTML转PDF（保留CSS样式）。  
  - 模板引擎：  
    - 基础模板：HTML/CSS + 占位符（如`{{diagnosis}}`）。  
    - 动态填充：用户编辑内容映射至模板变量。  
- **防错设计**  
  - 内容溢出检测：自动分页或警告提示。  

---

### **5. 数据存储与关联模块**  
#### 需求  
- 录音文件、转写文本、编辑后报告需关联存储。  
- 支持按时间、患者ID等多维度检索。  

#### 技术栈  
- **数据库设计**  
  ```javascript  
  // MongoDB Schema示例  
  const SessionSchema = new Schema({  
    userId: { type: ObjectId, ref: 'User' },  
    audioPath: String,     // 阿里云OSS路径  
    transcript: String,    // 原始转写文本  
    edits: [{              // 编辑历史  
      content: String,  
      timestamp: Date  
    }],  
    reportVersion: String  // 最终导出PDF路径  
  });  
  ```  
- **检索优化**  
  - Elasticsearch：索引患者ID、时间范围、关键词。  

---

## **三、核心问题解决方案**  
### **1. 录音与文本关联存储**  
- **实现逻辑**  
  ```text  
  前端录音 → 上传至阿里云OSS → 返回文件ID → 后端关联存储文件ID与转写文本  
  ```  
- **技术工具**  
  - 阿里云OSS SDK（前端直传 + STS临时令牌）。  

### **2. 固定排版保障**  
- **实现逻辑**  
  ```text  
  用户选择模板 → 编辑内容绑定模板变量 → 导出时渲染HTML → 转换为PDF  
  ```  
- **防错措施**  
  - 内容长度校验：限制单页字符数。  
  - 表格自动分页：CSS `page-break-inside: avoid`。  

### **3. 提示词工程优化**  
- **临床场景示例**  
  ```text  
  提示词模板：  
  "作为{科室}医生，患者{年龄}岁，主诉{症状}，检查结果显示{结果}，请提供诊断建议。"  
  ```  
- **技术工具**  
  - LangChain：支持上下文链式提示。  
  - A/B测试：对比不同提示词生成的准确率。  

---

## **四、部署与监控**  
- **前端部署**：Vercel（自动HTTPS + CDN）。  
- **后端部署**：Docker + AWS ECS（负载均衡）。  
- **监控**：  
  - Sentry：前端错误追踪。  
  - Grafana：服务性能监控（API响应时间、存储容量）。  

---

## **五、附录：技术栈全表**  
| 模块               | 技术栈                                                                 |  
|--------------------|----------------------------------------------------------------------|  
| **前端框架**       | Next.js + Tailwind CSS + TypeScript                                  |  
| **状态管理**       | Redux Toolkit + React Query                                         |  
| **语音处理**       | WebRTC + 阿里云OSS + FFmpeg微服务                                     |  
| **AI服务**         | Python微服务（FastAPI） + LangChain + GPT-4                          |  
| **数据库**         | MongoDB（主库） + Elasticsearch（检索）                               |  
| **安全**           | JWT + AES-256 + HTTPS                                                |  